#!/bin/bash

# Mise à jour des paquets
echo "Mise à jour des paquets..."
sudo apt update -y
sudo apt upgrade -y

# Installation de vsftpd
echo "Installation de vsftpd..."
sudo apt install vsftpd -y

# Sauvegarder le fichier de configuration original
echo "Sauvegarde du fichier de configuration original..."
sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.bak

# Configurer vsftpd pour FTP sécurisé
echo "Configuration de vsftpd..."

# Activer l'accès anonyme (désactivé par défaut, mais commenté)
sudo sed -i 's/anonymous_enable=YES/anonymous_enable=NO/' /etc/vsftpd.conf

# Activer les utilisateurs locaux
sudo sed -i 's/#local_enable=YES/local_enable=YES/' /etc/vsftpd.conf

# Activer l'autorisation d'écriture pour les utilisateurs locaux
sudo sed -i 's/#write_enable=YES/write_enable=YES/' /etc/vsftpd.conf

# Activer le téléchargement de fichiers par les utilisateurs locaux
sudo sed -i 's/#chroot_local_user=YES/chroot_local_user=YES/' /etc/vsftpd.conf

# Ajouter la configuration supplémentaire pour plus de sécurité
echo "Pasv_enable=YES" | sudo tee -a /etc/vsftpd.conf
echo "pasv_min_port=10000" | sudo tee -a /etc/vsftpd.conf
echo "pasv_max_port=10100" | sudo tee -a /etc/vsftpd.conf
echo "allow_writeable_chroot=YES" | sudo tee -a /etc/vsftpd.conf

# Redémarrage du service vsftpd
echo "Redémarrage du service FTP..."
sudo systemctl restart vsftpd

# Activer le démarrage de vsftpd au boot
sudo systemctl enable vsftpd

# Vérification de l'état du service
sudo systemctl status vsftpd

# Ajouter un utilisateur FTP
echo "Création d'un utilisateur FTP..."

# Nom de l'utilisateur
read -p "Entrez le nom de l'utilisateur FTP: " ftpuser
sudo adduser $ftpuser

# Optionnel : si vous souhaitez ajouter un dossier FTP spécifique pour l'utilisateur
read -p "Voulez-vous ajouter un répertoire dédié pour cet utilisateur (Y/n)? " response
if [[ "$response" =~ ^[Yy]$ ]]
then
  sudo mkdir -p /home/$ftpuser/ftp
  sudo chown nobody:nogroup /home/$ftpuser/ftp
  sudo chmod a-w /home/$ftpuser/ftp

  sudo mkdir /home/$ftpuser/ftp/files
  sudo chown $ftpuser:$ftpuser /home/$ftpuser/ftp/files

  echo "Le répertoire /home/$ftpuser/ftp a été créé et configuré."
fi

echo "Configuration du serveur FTP terminée."
